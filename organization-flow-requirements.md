# 組織所属フロー変更 要件定義書

## 1. 概要

ユーザーの組織所属フローを改善し、以下の2つの選択肢を提供する：
- 新規組織を作成する
- 既存組織からの招待を受ける

また、招待機能を拡張し、既存ユーザーも招待経由で組織に参加できるようにする。

## 2. 現状と変更点

### 2.1 現状の仕様
- ログイン後、組織未所属ユーザーは自動的に組織作成画面へリダイレクト
- 招待は未登録ユーザーのみ受諾可能
- 招待受諾時はメールアドレスの一致を確認

### 2.2 変更後の仕様
- ログイン後、組織未所属ユーザーは「組織作成」または「招待を受ける」を選択
- 招待は既存ユーザーも受諾可能
- 既存ユーザーは複数組織に所属可能

## 3. 詳細要件

### 3.1 組織選択画面の改修

**対象画面**: `/setup/organization` (OrganizationSetupForm.tsx)

**要件**:
1. 初期表示で2つの選択肢を表示
   - 「新しい組織を作成する」
   - 「招待を受ける」
2. 「新しい組織を作成する」選択時：現在の組織作成フォームを表示
3. 「招待を受ける」選択時：メッセージ画面を表示

### 3.2 招待を受ける画面

**要件**:
1. メッセージ: 「組織の管理者にメールで招待を送ってもらってください」
2. 「戻る」ボタンで選択画面に戻る
3. シンプルなUIで、追加情報は不要

### 3.3 招待機能の拡張

**変更対象API**: `/api/v1/organizations/:organizationId/invites`

**要件**:
1. 既存ユーザーのメールアドレスでも招待作成可能
2. 重複チェックの修正（同一組織内の既存メンバーのみチェック）
3. エラーメッセージの調整

### 3.4 招待受諾フローの改修

**変更対象API**: `/api/v1/organizations/:organizationId/invites/:token/accept`

**新規画面**: 組織参加確認画面

**要件**:
1. 未登録ユーザー：
   - 現行通りサインアップ画面へリダイレクト
   - サインアップ後、自動的に組織に参加
   - `current_organization_id`を設定
   
2. 既存ユーザー（未ログイン）：
   - ログイン画面へリダイレクト
   - ログイン後、組織参加確認画面を表示
   
3. 既存ユーザー（ログイン済み）：
   - 組織参加確認画面を表示
   - 「〇〇組織に参加しますか？」
   - 「参加する」「キャンセル」ボタン
   - 参加後も`current_organization_id`は変更しない

### 3.5 ログイン時のリダイレクトロジック

**対象ファイル**: `lib/auth.tsx`

**要件**:
1. 組織未所属の場合は`/setup/organization`へリダイレクト（変更なし）
2. 招待トークンがある場合の処理を追加

## 4. 技術設計

### 4.1 データベース変更
- 変更なし（既存のスキーマで対応可能）

### 4.2 API変更

#### POST /api/v1/organizations/:organizationId/invites
```javascript
// 変更前のチェック
const existingMember = await db.query(
  'SELECT 1 FROM organization_members om JOIN profiles p ON om.user_id = p.id WHERE om.organization_id = $1 AND p.email = $2',
  [organizationId, email]
);

// 変更後のチェック - エラーを出さない、または警告のみ
```

#### POST /api/v1/organizations/:organizationId/invites/:token/accept
```javascript
// 既存ユーザーの処理を追加
if (req.user) {
  // すでに組織メンバーかチェック
  const isMember = await checkMembership(req.user.id, organizationId);
  if (isMember) {
    return res.status(400).json({ error: 'すでにこの組織のメンバーです' });
  }
  
  // 確認画面へのリダイレクト情報を返す
  return res.json({ 
    requiresConfirmation: true,
    organizationName: organization.name,
    invitationId: invitation.id
  });
}
```

### 4.3 フロントエンド変更

#### OrganizationSetupForm.tsx
- 状態管理: `selectedOption: 'create' | 'join' | null`
- 条件付きレンダリング

#### 新規コンポーネント: JoinOrganizationConfirmation.tsx
- 招待受諾確認画面
- 組織名表示
- 参加/キャンセルボタン

#### auth.tsx
- 招待トークン付きログインの処理

## 5. 実装タスクリスト

### Phase 1: 組織選択画面の改修
- [ ] OrganizationSetupForm.tsxに選択UI追加
- [ ] 「新しい組織を作成する」選択時の既存フォーム表示
- [ ] 「招待を受ける」選択時のメッセージ画面実装
- [ ] 「戻る」ボタンの実装
- [ ] スタイリング調整

### Phase 2: 招待API拡張
- [ ] POST /api/v1/organizations/:organizationId/invitesの既存ユーザーチェック修正
- [ ] 重複メンバーチェックのロジック変更
- [ ] エラーメッセージの調整
- [ ] APIテストの更新

### Phase 3: 招待受諾フロー改修
- [ ] 既存ユーザー判定ロジックの追加
- [ ] 確認画面用のレスポンス追加
- [ ] APIエンドポイントの条件分岐実装
- [ ] メールアドレス一致確認の削除

### Phase 4: フロントエンド招待受諾
- [ ] JoinOrganizationConfirmation.tsxコンポーネント作成
- [ ] 組織参加確認UIの実装
- [ ] 招待受諾APIコール実装
- [ ] 成功/エラーハンドリング
- [ ] 適切なリダイレクト処理

### Phase 5: ログインフロー調整
- [ ] auth.tsxの招待トークン処理追加
- [ ] ログイン後の招待受諾フロー実装
- [ ] セッション管理の調整

### Phase 6: テストと品質保証
- [ ] 新規ユーザーの招待受諾フローテスト
- [ ] 既存ユーザーの招待受諾フローテスト
- [ ] 複数組織所属のテスト
- [ ] エラーケースのテスト
- [ ] UI/UXの確認

### Phase 7: ドキュメント更新
- [ ] APIドキュメントの更新
- [ ] ユーザーガイドの更新
- [ ] 管理者向けドキュメントの更新

## 6. 注意事項

1. **後方互換性**: 既存の招待リンクも引き続き動作すること
2. **セキュリティ**: 招待トークンの検証は厳密に行う
3. **UX**: 組織切り替えは既存のプロフィールメニューから行う
4. **エラーハンドリング**: 適切なエラーメッセージを表示

## 7. 画面遷移図

```
[ログイン] 
  ↓ (組織未所属)
[組織選択画面]
  ├→ [組織作成] → [組織作成完了] → [ダッシュボード]
  └→ [招待を受ける] → [メッセージ表示] ← [戻る]

[招待メールリンク]
  ├→ (未登録) → [サインアップ] → [組織参加] → [ダッシュボード]
  └→ (既存ユーザー) → [ログイン] → [参加確認] → [現在の組織維持]
```

## 8. 実装優先順位

1. **高**: 組織選択画面の改修（Phase 1）
2. **高**: 招待API拡張（Phase 2）
3. **高**: 招待受諾フロー改修（Phase 3-4）
4. **中**: ログインフロー調整（Phase 5）
5. **低**: テストとドキュメント（Phase 6-7）

この要件定義書に基づいて実装を進めることで、ユーザーにより柔軟な組織参加オプションを提供できます。